package com.example.hm_project.view.activity;


import android.content.Context;
import android.content.Intent;
import android.os.Build;
import android.os.Bundle;
import android.util.Log;
import android.view.View;

import androidx.annotation.RequiresApi;
import androidx.appcompat.app.AppCompatActivity;
import androidx.databinding.DataBindingUtil;

import com.example.hm_project.Command.ClickListener;
import com.example.hm_project.Command.EditTextInput;
import com.example.hm_project.Command.JsonMaker;
import com.example.hm_project.R;
import com.example.hm_project.Command.InterfaceManager;
import com.example.hm_project.data.LoginJsonData;
import com.example.hm_project.data.PreferenceManager;
import com.example.hm_project.databinding.ActivityFindpasswordBinding;
import com.example.hm_project.etc.PopupActivity;
import com.example.hm_project.util.CodeManager;
import com.example.hm_project.util.Crypto;
import com.example.hm_project.util.HM_Singleton;
import com.example.hm_project.util.JsonParser;
import com.example.hm_project.util.NetworkManager;

import java.net.URL;

/***
 *  비밀번호 찾기
 *  1- 비밀번호 찾기 버튼 클릭시 이벤트
 *  2- 비밀번호 찾기 성공시 이벤트
 *  3- 빈칸 확인 ( 비밀번호 찾기 필수정보 입력칸 )
 */

public class FindPasswordActivity extends AppCompatActivity {

    private Context mContext;
    private JsonParser jsonParser = HM_Singleton.getInstance(new JsonParser());
    private EditTextInput editTextInput = new EditTextInput();
    private ClickListener clickListener = new ClickListener();
    private ActivityFindpasswordBinding binding;

    private String serverData;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        binding = DataBindingUtil.setContentView(this, R.layout.activity_findpassword);
        binding.setActivity(this);

        //EditText에서 이메일을 입력받을 때 이메일형식대로 입력하지 않으면 빨간색 테두리로 알려준다.
        editTextInput.inputEmail(binding.fpInputEmail, binding.fpErrorEmail);
        //EditText에서 핸드폰번호를 입력받을 때 정해진 형식대로 입력하지 않으면 빨간색 테두리로 알려준다.
        editTextInput.inputPhoneNO(binding.fpInputPhoneNO, binding.fpErrorPhoneNO);
    }

    // 1 - 비밀번호 찾기 버튼 클릭시 이벤트
    @RequiresApi(api = Build.VERSION_CODES.O)
    public void onFindPasswordClick(View view) {
        mContext = this;
        if (!fpEmpty()) {
            // 이메일입력을 하지 않았을 때
            if (EditTextInput.checkNPE(binding.fpInputEmail.getText().toString())) {
                binding.fpErrorEmail.setText("필수 정보입니다.");
            }// 이름입력을 하지 않았을 때
            if (EditTextInput.checkNPE(binding.fpInputName.getText().toString())) {
                binding.fpErrorName.setText("필수 정보입니다.");
            } // 핸드폰번호입력을 하지 않았을 때
            if (EditTextInput.checkNPE(binding.fpInputPhoneNO.getText().toString())) {
                binding.fpErrorPhoneNO.setText("필수 정보입니다.");
            }
        } else {
            // 네트워크 연결이 되었는지 확인
            if (NetworkManager.networkCheck(getApplicationContext())) {
                serverCheck(); // 서버가 열렸는지 확인
                if ("Yes".equals(serverData)) { // 서버가 열렸다면 실행
                    try {
                        URL url = new URL("http://218.234.77.97:8080/HairManager/login/FindPassword.jsp");

                        InterfaceManager task = new InterfaceManager(url);
                        String json = JsonMaker.jsonObjectMaker(binding.fpInputEmail.getText().toString(), "",
                                binding.fpInputName.getText().toString(), binding.fpInputPhoneNO.getText().toString(), "", "", "", "", "");
                        String returns = task.execute(json).get(); // 9

                        // 서버로부터 온 값을 파싱해서 가져온다.
                        LoginJsonData loginJsonData = jsonParser.jsonParsingFindPassword(returns);

                        String code = loginJsonData.getCode();
                        String tempKey = loginJsonData.getData1();
                        String tempPassword = loginJsonData.getData2();

                        if (code.trim().equals("SY_2000")) {
                            Crypto.secretKEY = tempKey;
                            String decrpyt = Crypto.decryptAES256(tempPassword);
                            //임시비밀번호 로그인 화면에 자동으로 띄워주기 위해 저장.
                            PreferenceManager.setString(mContext, "findPassword", decrpyt);
                            // 팝업화면 띄움
                            clickListener.popupEventReturn(FindPasswordActivity.this, "비밀번호 찾기 성공", "임시비밀번호 : " + decrpyt + "\n" + "유효기간 :  24시간");
                            Log.i("임시비밀번호 발급 성공", code + " " + decrpyt);
                        } else {
                            clickListener.popupEvent(FindPasswordActivity.this, "비밀번호 찾기 실패", "입력정보를 확인해주세요.");
                            Log.i("알수 없는 오류 입니다.", "오류오류오류1");
                        }
                    } catch (Exception e) {
                    }
                } else {
                    clickListener.popupEvent(FindPasswordActivity.this, "서버 연결 오류", "비밀번호 찾기 실패");
                }
            } else {
                viewPopup(CodeManager.NewtWork_Error); // 네트워크 연결이 안되었다는 알림 팝업 띄움
            }
        }
    }

    // 2 - 비밀번호 찾기 성공시 이벤트
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == 1) {
            if (resultCode == RESULT_OK) {
                //데이터 받기
                Intent intent2 = new Intent(FindPasswordActivity.this, LoginActivity.class);
                startActivity(intent2);
                FindPasswordActivity.this.finish();
            }
        }
    }

    // 3 - 빈칸 확인 ( 비밀번호 찾기 필수정보 입력칸 )
    private boolean fpEmpty() {
        if (EditTextInput.checkNPE(binding.fpInputEmail.getText().toString())) {
            return false;
        } else if (binding.fpErrorEmail.getText().toString().equals("이메일 형식으로 입력해주세요.")) {
            return false;
        } else if (EditTextInput.checkNPE(binding.fpInputName.getText().toString())) {
            return false;
        } else if (EditTextInput.checkNPE(binding.fpInputPhoneNO.getText().toString())) {
            return false;
        } else if (binding.fpErrorPhoneNO.getText().toString().equals("핸드폰번호 형식에 맞게 입력해주세요.")) {
            return false;
        } else
            return true;
    }

    private void serverCheck() {
        try {
            URL url = new URL("http://218.234.77.97:8080/HairManager/login/ServerCheck.jsp");

            InterfaceManager task = new InterfaceManager(url);
            serverData = task.execute("").get();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    //팝업창 메소드
    private void viewPopup(int CODE) {
        Intent intent = new Intent(getApplicationContext(), PopupActivity.class);
        intent.putExtra("code", CODE);
        startActivity(intent);
    }

    @Override
    public void onBackPressed() {
        //super.onBackPressed();
        clickListener.moveActivity(this, LoginActivity.class);
    }
}